name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null
          # Debug: verify key
          head -1 ~/.ssh/deploy_key
          tail -1 ~/.ssh/deploy_key
          wc -l ~/.ssh/deploy_key
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} echo 'SSH connection successful'

      - name: Deploy to Droplet
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} << 'ENDSSH'
          set -euo pipefail
          
          cd /opt/dashboard/app
          
          if [ ! -d ".git" ]; then
            cd /opt/dashboard
            rm -rf app
            git clone https://github.com/JithendraNara/it-dashboard.git app
            mkdir -p app/data
            chown -R www-data:www-data app/data
          else
            git config --global --add safe.directory /opt/dashboard/app
            git fetch origin
            git reset --hard origin/main
          fi
          
          /opt/dashboard/venv/bin/pip install -q -r requirements.txt
          
          systemctl restart dashboard
          
          sleep 3
          curl -sf http://localhost:8000/health || echo "WARNING: health check failed"
          
          echo "Deploy complete at $(date)"
          ENDSSH

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
